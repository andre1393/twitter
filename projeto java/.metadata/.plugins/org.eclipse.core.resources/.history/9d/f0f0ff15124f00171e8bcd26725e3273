import java.util.List;

import twitter4j.Query;
import twitter4j.QueryResult;
import twitter4j.Status;
import twitter4j.Twitter;
import twitter4j.TwitterException;
import twitter4j.TwitterFactory;
import twitter4j.conf.ConfigurationBuilder;

/**
 * Implentação dos métodos para leitura dos dados do twitter
 * @author André Oliveira
 */
public class TwitterAPI {
	
	ConfigurationBuilder cb;
	ConfigurationBuilder cb_stream;
	String keyWords[];
	String params[];
	
	public TwitterAPI(String consumerKey, String consumerSecret, 
					  String accessToken, String accessTokenSecret, 
					  String[] key_words, String[] params_)
	{
		keyWords = key_words;
		params = params_;
		cb = new ConfigurationBuilder();
		cb_stream = new ConfigurationBuilder();
		
		
		cb.setDebugEnabled(true)
		.setOAuthConsumerKey(consumerKey)
		.setOAuthConsumerSecret(consumerSecret)
		.setOAuthAccessToken(accessToken)
		.setOAuthAccessTokenSecret(accessTokenSecret);
		
		cb_stream.setDebugEnabled(true)
		.setOAuthConsumerKey(consumerKey)
		.setOAuthConsumerSecret(consumerSecret)
		.setOAuthAccessToken(accessToken)
		.setOAuthAccessTokenSecret(accessTokenSecret);
	}
	
	/**
	 * busca pelos ultimos 100 tweets dada uma #tag
	 * @param key - #tag a ser buscada
	 * @return uma string contendo todos os resultados da busca, separados por parametros
	 */
	public String getLastTweet(String key)
	{	
		String searchResult = ""; // resultado da busca
        Twitter twitterSearch = new TwitterFactory(cb.build()).getInstance();
        try 
        {
        	Query querySearch = new Query(key);
        	querySearch.count(100); // quantidade maxima de resultados da busca
        	QueryResult resultSearch = twitterSearch.search(querySearch); // resultado da busca
        	List<Status> tweets = resultSearch.getTweets(); // lista com todos os tweets encontrados
        	for (Status tweetSearch : tweets) {
        		searchResult += (params[0] + "@" + tweetSearch.getUser().getScreenName() + 
        						 params[1] + tweetSearch.getText().replaceAll("\\n", "") + 
        						 params[2] + tweetSearch.getId());
        	}        
        }catch (TwitterException err) {
            err.printStackTrace();
            System.out.println("Falha ao pesquisar pela #tag: " + err.getMessage());
        }
        
        return searchResult;
	}
}
